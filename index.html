<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FIN-JOD · สรุปภาพรวม (โหลดพร้อมกัน + ปุ่ม Busy)</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#1e1e1e; --panel:#242424; --line:#3a3a3a; --muted:#bfbfbf; --text:#f1f1f1;
      --primary:#00c896; --danger:#ff4d4f; --blue:#6c8cff; --cyan:#2dd4bf; --warn:#ffb020;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; padding:clamp(.75rem,2vw,1.25rem);
      padding-bottom:calc(clamp(.75rem,2vw,1.25rem) + env(safe-area-inset-bottom,0px));
      font-family:'Kanit',sans-serif; background:var(--bg); color:var(--text) }
    .wrap{ width:min(1140px,100%); margin:auto; background:var(--panel); border:1px solid var(--line);
      border-radius:20px; padding:clamp(1rem,2.2vw,1.5rem) }
    h1{ margin:.25rem 0 1rem; font-size:clamp(1.25rem,4.5vw,1.8rem); color:var(--primary); text-align:center }
    .head{ display:flex; align-items:center; gap:.75rem; margin-bottom:.75rem }
    .head .you{ margin-left:auto; color:#9fe9d4; font-weight:600 }

    .row{ display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1rem }
    .col{ flex:1 1 46%; min-width:230px; display:flex; flex-direction:column; gap:.35rem }
    label{ color:var(--muted) }
    input,select,button{ border-radius:12px; border:1px solid var(--line); background:#1d1d1d; color:#fff; min-height:44px; padding:.9rem 1rem; font-size:16px }
    button{ background:var(--primary); border:none; font-weight:700; cursor:pointer; position:relative }
    button:disabled{ opacity:.6; cursor:not-allowed }
    .btn-ghost{ background:#333 } .btn-blue{ background:var(--blue) } .btn-warn{ background:var(--warn); color:#222 }

    /* ปุ่มกำลังโหลด: วงกลมเล็ก */
    button[aria-busy="true"]{ pointer-events:none }
    button[aria-busy="true"]::after{
      content:""; position:absolute; right:10px; top:50%; transform:translateY(-50%);
      width:18px; height:18px; border-radius:50%;
      border:3px solid #3a3a3a; border-top-color:#fff; animation:spin 1s linear infinite;
    }

    .card{ background:#1f1f1f; border:1px solid var(--line); border-radius:16px; padding:1rem }
    .muted{ color:var(--muted) }
    .hide{ display:none }

    .chips{ display:flex; gap:.5rem; flex-wrap:wrap }
    .chip{ padding:.5rem .8rem; border-radius:999px; background:#2a2a2a; border:1px solid var(--line); cursor:pointer; user-select:none }
    .chip.active{ background:var(--blue) }

    .kpi{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1rem }
    .kpi .card{ display:flex; flex-direction:column; gap:.35rem; min-height:92px }
    .right{ text-align:right }

    .bar-track{ height:10px; background:#3a3a3a; border-radius:999px; overflow:hidden }
    .bar-fill{ height:100%; width:0% }
    #budgetBar{ background:linear-gradient(90deg,#6c8cff,#ffb020,#ff4d4f) }
    #savingBar{ background:linear-gradient(90deg,#2dd4bf,#00c896) }

    .grid2{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1rem }
    .chart-wrap{ height:260px; width:100% } .chart-wrap canvas{ width:100% !important; height:100% !important; display:block }

    #toast{ position:fixed; left:50%; bottom:calc(18px + env(safe-area-inset-bottom,0px)); transform:translateX(-50%);
      background:#333; color:#fff; padding:.6rem .9rem; border-radius:10px; opacity:0; transition:.3s; pointer-events:none; z-index:60 }

    /* Overlay ใช้เฉพาะตอน init LIFF */
    #overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); backdrop-filter:blur(2px); z-index:99; transition:.2s }
    #overlay.hide{ opacity:0; pointer-events:none }
    .spinner{ width:48px; height:48px; border-radius:50%; border:5px solid #3a3a3a; border-top-color:#fff; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .skeleton{ position:relative; overflow:hidden; background:#2b2b2b; border-radius:8px; min-height:28px }
    .skeleton::after{ content:""; position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent); animation:skeleton 1.2s infinite }
    @keyframes skeleton{ 100%{ transform:translateX(100%); } }
  </style>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1 style="margin:0">สรุปภาพรวม</h1>
      <div class="you" id="who"></div>
    </div>

    <!-- ช่วงวันที่ + ปุ่มลัด -->
    <div class="card" style="margin-bottom:1rem">
      <div class="row">
        <div class="col"><label for="fFrom">จาก</label><input id="fFrom" type="date"></div>
        <div class="col"><label for="fTo">ถึง</label><input id="fTo" type="date"></div>
        <div class="col">
          <label>&nbsp;</label>
          <div class="chips">
            <div class="chip" data-range="today">วันนี้</div>
            <div class="chip" data-range="7">7 วัน</div>
            <div class="chip" data-range="30">30 วัน</div>
            <div class="chip" data-range="month">เดือนนี้</div>
            <div class="chip" data-range="year">ปีนี้</div>
            <button id="btnRefresh" class="btn-blue" style="margin-left:auto">รีเฟรช</button>
          </div>
          <div class="muted" style="margin-top:.4rem">กำลังดู: <b id="rangeBadge">กำหนดเอง</b></div>
        </div>
      </div>
    </div>

    <!-- งบเดือนนี้ & เป้าออม -->
    <div class="card" style="margin-bottom:1rem">
      <div class="row">
        <div class="col">
          <label for="budgetThisMonth">งบรายจ่ายเดือนนี้ (บาท)</label>
          <input id="budgetThisMonth" type="number" step="0.01" placeholder="เช่น 10000">
        </div>
        <div class="col">
          <label for="savingGoalThisMonth">เป้าออมเดือนนี้ (บาท)</label>
          <input id="savingGoalThisMonth" type="number" step="0.01" placeholder="เช่น 1500">
        </div>
        <div class="col" style="align-self:flex-end">
          <button id="btnSaveBudget" class="btn-warn">บันทึกงบ/เป้าออม</button>
        </div>
      </div>
      <div class="row" style="margin-top:.25rem">
        <div class="col" style="min-width:260px">
          <div class="muted">ใช้ไป: <b id="budgetUsedPct">—</b></div>
          <div class="bar-track"><div id="budgetBar" class="bar-fill"></div></div>
          <div class="muted" id="budgetStatus" style="margin-top:.25rem">รายจ่ายเดือนนี้: —</div>
        </div>
        <div class="col" style="min-width:260px">
          <div class="muted">ออมแล้ว: <b id="savingGoalPct">—</b></div>
          <div class="bar-track"><div id="savingBar" class="bar-fill"></div></div>
          <div class="muted" style="margin-top:.25rem">สถานะออมเดือนนี้: <b id="savingGoalStatus">—</b></div>
        </div>
      </div>
    </div>

    <!-- KPI -->
    <div class="kpi" style="margin-bottom:1rem">
      <div class="card"><div class="muted">รายรับรวม</div><div id="sumIncome"  style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
      <div class="card"><div class="muted">รายจ่ายรวม</div><div id="sumExpense" style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
      <div class="card"><div class="muted">ออมสุทธิ</div><div id="sumSaving" style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
      <div class="card" id="netCard"><div class="muted">คงเหลือ</div><div id="sumNet"     style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
      <div class="card"><div class="muted">หนี้คงเหลือรวม</div><div id="sumDebt"    style="font-size:1.6rem;font-weight:700" class="skeleton"></div></div>
    </div>

    <!-- Charts -->
    <div class="grid2" style="margin-bottom:1rem">
      <div class="card">
        <div class="muted" style="margin-bottom:.4rem">รายจ่ายตามหมวด</div>
        <div id="noDataExp" class="muted hide">ยังไม่มีข้อมูลในช่วงนี้</div>
        <div class="chart-wrap"><canvas id="chartExp"></canvas></div>
      </div>
      <div class="card">
        <div class="muted" style="margin-bottom:.4rem">กระแสเงินสด (รายวัน & สะสม)</div>
        <div id="noDataFlow" class="muted hide">ยังไม่มีข้อมูลในช่วงนี้</div>
        <div class="chart-wrap"><canvas id="chartFlow"></canvas></div>
      </div>
    </div>

    <div class="grid2" style="margin-bottom:1rem">
      <div class="card">
        <div class="muted" style="margin-bottom:.4rem">หนี้คงเหลือรวม (จำลองรายวัน)</div>
        <div id="noDataDebtTS" class="muted hide">ยังไม่มีข้อมูลหนี้ในช่วงนี้</div>
        <div class="chart-wrap"><canvas id="chartDebtTS"></canvas></div>
      </div>
      <div class="card">
        <div class="muted" style="margin-bottom:.4rem">จ่ายต้น vs จ่ายดอก (รายเดือน)</div>
        <div id="noDataPI" class="muted hide">ยังไม่มีธุรกรรมหนี้ในช่วงนี้</div>
        <div class="chart-wrap"><canvas id="chartPI"></canvas></div>
      </div>
    </div>

    <div class="card">
      <div class="muted" style="margin-bottom:.4rem">ออมเงินสะสม (ฝาก − ถอน)</div>
      <div id="noDataSav" class="muted hide">ยังไม่มีข้อมูลในช่วงนี้</div>
      <div class="chart-wrap"><canvas id="chartSavCum"></canvas></div>
    </div>
  </div>

  <div id="toast">แจ้งเตือน</div>
  <div id="overlay" class="hide" aria-live="polite" aria-busy="true"><div class="spinner"></div></div>

<script>
/** ====== CONFIG ====== */
const LIFF_ID = '2008276151-Oyp12d62';
const API_URL = 'https://script.google.com/macros/s/AKfycbxV3xOU1kQM86jUJtfer8hW_HgYkcLfpH942saPVbCZ1RDmN_4LYjpk72OxdKKLQAFt/exec';
const BUD_CAT_OVERALL   = '__BUDGET_OVERALL__';
const BUD_CAT_SAVE_GOAL = '__SAVING_GOAL__';

/** ====== STATE ====== */
let token = localStorage.getItem('fin_token') || '';
let displayName = localStorage.getItem('fin_name') || '';
let cats = { income:[], expense:[], saving:[] };
let withdrawIncomeIds = new Set();
const monthSettingsCache = {};
let lastItems = [];

/** ====== HELPERS ====== */
const $ = s => document.querySelector(s);
const fmt = n => Number(n||0).toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2});
const esc = s => String(s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
const toast = (msg, ok=true)=>{ const el=$('#toast'); el.textContent=msg; el.style.background = ok ? '#00c896' : '#ff4d4f'; el.style.opacity='1'; setTimeout(()=> el.style.opacity='0', 2200); };
const showOverlay = (on)=> $('#overlay').classList.toggle('hide', !on);
function toYMD(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function todayISO(){ return toYMD(new Date()); }
function monthBounds(d){ return { start: toYMD(new Date(d.getFullYear(), d.getMonth(), 1)), end: toYMD(new Date(d.getFullYear(), d.getMonth()+1, 0)) }; }
const sum = (arr, pick) => arr.reduce((s,x)=> s+(pick(x)||0), 0);
const groupBy = (arr, key) => arr.reduce((a,x)=> ((a[key(x)] = a[key(x)]||[]).push(x),a),{});
const runningSum = arr => { let s=0; return arr.map(v => (s+=v, s)); };

/* ปุ่ม busy เฉพาะปุ่ม */
function setBusy(btn, on, tempText){
  if (!btn) return;
  if (on){
    btn.dataset._text = btn.textContent;
    if (tempText) btn.textContent = tempText;
    btn.setAttribute('aria-busy','true');
    btn.disabled = true;
  }else{
    btn.disabled = false;
    btn.removeAttribute('aria-busy');
    if (btn.dataset._text){ btn.textContent = btn.dataset._text; delete btn.dataset._text; }
  }
}
async function withBusy(btn, fn, textWhile='กำลังโหลด…'){
  setBusy(btn, true, textWhile);
  try{ return await fn(); } finally{ setBusy(btn, false); }
}

/** ====== FETCH/API ====== */
async function fetchJSON(url, options={}){
  try{
    const res = await fetch(url, { ...options, headers:{'Content-Type':'text/plain;charset=utf-8', ...(options.headers||{})} });
    const text = await res.text();
    try { return JSON.parse(text); } catch{ return { ok:false, error:'NON_JSON', raw:text }; }
  }catch(e){ return { ok:false, error:'NETWORK', message:String(e&&e.message||e) }; }
}
async function api(path, payload={}, useToken=true){
  const body = { path, payload }; if (useToken && token) body.token = token;
  return fetchJSON(API_URL, { method:'POST', body: JSON.stringify(body) });
}

/** ====== LIFF LOGIN (auto) ====== */
async function ensureTokenViaLIFF(){
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return false; }

  let prof; try{ prof = await liff.getProfile(); }catch{ toast('อ่านโปรไฟล์ LINE ไม่ได้', false); return false; }
  const r = await api('liff/link_or_login', { line_user_id: prof.userId, display_name: prof.displayName||'' }, false);
  if (!r.ok){ toast(r.message || 'เกิดข้อผิดพลาด', false); return false; }

  if (r.need_verification){
    $('#who').textContent = prof.displayName || '';
    toast('ยังไม่ผูกบัญชี เข้าหน้าอื่นเพื่อผูกบัญชีก่อน', false);
    return false;
  }

  token = r.token; displayName = r.display_name || prof.displayName || '';
  localStorage.setItem('fin_token', token);
  localStorage.setItem('fin_name', displayName);
  $('#who').textContent = displayName;
  return true;
}

/** ====== CATEGORIES ====== */
function _isWithdrawIncomeName(name){ const s = String(name||''); return /ถอน.*ออม|ออม.*ถอน|ถอนออม|ถอนเงินออม|withdraw.*(save|saving)|saving.*withdraw/i.test(s); }
async function loadCategoriesAll(){
  const types = ['income','expense','saving'];
  const [ri, re, rs] = await Promise.all([
    api('categories/list', { type:'income' }, true),
    api('categories/list', { type:'expense' }, true),
    api('categories/list', { type:'saving' }, true),
  ]);
  cats.income  = ri.ok ? (ri.items||[]) : [];
  cats.expense = re.ok ? (re.items||[]) : [];
  cats.saving  = rs.ok ? (rs.items||[]) : [];
  withdrawIncomeIds = new Set((cats.income||[]).filter(c=> _isWithdrawIncomeName(c.name_th)).map(c=> c.category_id));
}

/** ====== BUDGET/GOAL SETTINGS ====== */
function monthKeyFromRange(){ const f=$('#fFrom').value; return (f||todayISO()).slice(0,7); }
async function loadMonthSettings(mk){
  if (monthSettingsCache[mk]) return monthSettingsCache[mk];
  const r = await api('budgets/list', { month: mk }, true);
  let budget=0, goal=0;
  if (r.ok){
    for (const it of (r.items||[])) {
      const cid = String(it.category_id);
      if (cid === BUD_CAT_OVERALL)   budget = Number(it.limit_amount||0);
      if (cid === BUD_CAT_SAVE_GOAL) goal   = Number(it.limit_amount||0);
    }
  }
  monthSettingsCache[mk] = { budget, goal };
  return monthSettingsCache[mk];
}
async function saveMonthSettings(mk, budget, goal){
  const [r1, r2] = await Promise.all([
    api('budgets/upsert', { month: mk, category_id: BUD_CAT_OVERALL,   limit_amount:Number(budget||0) }, true),
    api('budgets/upsert', { month: mk, category_id: BUD_CAT_SAVE_GOAL, limit_amount:Number(goal||0)   }, true),
  ]);
  if (r1.ok && r2.ok){ monthSettingsCache[mk] = { budget:Number(budget||0), goal:Number(goal||0) }; toast('บันทึกงบ/เป้าออมสำเร็จ'); return true; }
  toast('บันทึกงบ/เป้าออมไม่สำเร็จ', false); return false;
}

/** ====== RANGE SHORTCUTS ====== */
function setRange(from, to){ $('#fFrom').value = from; $('#fTo').value = to; updateRangeUI(); refreshDash(); }
function setRangeDaysBack(days){
  const now=new Date(); const from=toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-days+1)); const to=toYMD(now);
  setRange(from, to);
}
function updateRangeUI(){
  const f=$('#fFrom').value, t=$('#fTo').value;
  const today = todayISO();
  const mb = monthBounds(new Date());
  const y = new Date().getFullYear();
  const flags = {
    today: (f===today && t===today),
    d7: (f===toYMD(new Date(new Date().setDate(new Date().getDate()-6))) && t===today),
    d30:(f===toYMD(new Date(new Date().setDate(new Date().getDate()-29))) && t===today),
    month: (f===mb.start && t===mb.end),
    year: (f===`${y}-01-01` && t===`${y}-12-31`),
  };
  document.querySelectorAll('.chip[data-range]').forEach(ch=>{
    const key = ch.dataset.range;
    const on = (key==='today' && flags.today) || (key==='7' && flags.d7) || (key==='30' && flags.d30) || (key==='month' && flags.month) || (key==='year' && flags.year);
    ch.classList.toggle('active', !!on);
  });
  let txt='กำหนดเอง';
  if (flags.today) txt='วันนี้'; else if (flags.d7) txt='7 วันล่าสุด'; else if (flags.d30) txt='30 วันล่าสุด'; else if (flags.month) txt='เดือนนี้'; else if (flags.year) txt='ปีนี้';
  $('#rangeBadge').textContent = txt;
}

/** ====== DASH LOGIC ====== */
let chartExp=null, chartFlow=null, chartSavCum=null, chartDebtTS=null, chartPI=null;
function setKpiLoading(on){
  ['sumIncome','sumExpense','sumSaving','sumNet','sumDebt'].forEach(id=>{
    const el=$('#'+id); if (on){ el.classList.add('skeleton'); el.textContent=''; } else { el.classList.remove('skeleton'); }
  });
}
function colorizeNetCard(netVal){ $('#netCard').style.border = netVal>=0 ? '1px solid rgba(0,200,150,.35)' : '1px solid rgba(255,77,79,.35)'; }

async function refreshDash(silent){
  if (!token){ if(!silent) toast('ยังไม่ได้รับสิทธิ์เข้าใช้งาน', false); return; }
  setKpiLoading(true);
  if (!cats.expense.length && !cats.income.length && !cats.saving.length){ await loadCategoriesAll(); }

  const mk   = monthKeyFromRange();
  const from = $('#fFrom').value, to = $('#fTo').value;
  const today = todayISO();
  const endForDebt = (!to || to > today) ? today : to;

  // โหลด “พร้อมกัน” ทั้งหมด
  const [settings, rTx, rDebtSum, rDebtTx] = await Promise.all([
    loadMonthSettings(mk),
    api('transactions/list', { from, to, type:'all' }, true),
    api('debts/summary', {}, true),
    api('debts/tx/list', { from, to:endForDebt }, true),
  ]);

  if (!rTx.ok){ setKpiLoading(false); if(!silent) toast('โหลดรายการไม่สำเร็จ', false); return; }
  lastItems = (rTx.items||[]).map(x=> ({...x, amount:+x.amount}));

  // KPI
  const inc = sum(lastItems, x=> x.type==='income'? x.amount:0);
  const exp = sum(lastItems, x=> x.type==='expense'? x.amount:0);
  const savDep = sum(lastItems, x=> x.type==='saving'? x.amount:0);
  const savWd  = sum(lastItems, x=> x.type==='income' && withdrawIncomeIds.has(x.category_id) ? x.amount : 0);
  const savNet = Math.max(0, savDep - savWd);
  const net    = inc - exp - savDep;

  $('#sumIncome').textContent = fmt(inc);
  $('#sumExpense').textContent = fmt(exp);
  $('#sumSaving').textContent  = fmt(savNet);
  $('#sumNet').textContent     = fmt(net);
  $('#sumDebt').textContent    = rDebtSum.ok ? fmt(Number(rDebtSum.totals?.total||0)) : '—';
  colorizeNetCard(net);
  setKpiLoading(false);

  updateBudgetUI(exp, savNet, mk, settings);

  // วาดกราฟจากข้อมูลที่ดึงมาแล้ว (ไม่ยิง API ซ้ำ)
  const mapCat = Object.fromEntries((cats.expense.concat(cats.income).concat(cats.saving)).map(c=> [c.category_id, c.name_th]));
  drawExpByCat(lastItems, mapCat);
  drawFlow(lastItems);
  drawSavingCum(lastItems);

  drawDebtNetTotalOverTime(endForDebt, rDebtSum, rDebtTx);  // จำลองรายวันจาก summary + tx
  drawPrincipalInterestMonthly(rDebtTx);                    // ใช้ tx เดิม
}

function updateBudgetUI(expenseTotal, savingNet, mk, settingsFromCall){
  const cache = settingsFromCall || monthSettingsCache[mk] || { budget:0, goal:0 };
  monthSettingsCache[mk] = cache;
  const b = Number(cache.budget||0), g = Number(cache.goal||0);

  const pct = (!b || b<=0) ? 0 : Math.round((expenseTotal/b)*100);
  $('#budgetUsedPct').textContent = b>0 ? `${pct}%` : '—';
  $('#budgetBar').style.width = (b>0 ? Math.min(pct,100) : 0) + '%';

  let bTxt = 'รายจ่ายเดือนนี้: —';
  if (b>0){
    if (expenseTotal > b) bTxt = `รายจ่ายเดือนนี้: เกินมา ${fmt(expenseTotal - b)}`;
    else                  bTxt = `รายจ่ายเดือนนี้: เหลืองบ ${fmt(b - expenseTotal)}`;
  }
  $('#budgetStatus').textContent = bTxt;

  const pctSave = (!g || g<=0) ? 0 : Math.round((savingNet/g)*100);
  $('#savingGoalPct').textContent = g>0 ? `${pctSave}%` : '—';
  $('#savingBar').style.width = (g>0 ? Math.min(pctSave,100) : 0) + '%';
  let sTxt='—';
  if (g>0){
    if (savingNet>=g) sTxt = `ถึงเป้าแล้ว (+${fmt(savingNet-g)})`;
    else              sTxt = `ขาดอีก ${fmt(g - savingNet)}`;
  }
  $('#savingGoalStatus').textContent = sTxt;
}

/** ====== Charts (ไม่เรียก API เพิ่ม) ====== */
function drawExpByCat(items, mapCat){
  const panelNo = $('#noDataExp'); if (window.chartExp) chartExp.destroy();
  const exps = items.filter(x=>x.type==='expense');
  if (!exps.length){ panelNo.classList.remove('hide'); chartExp=null; return; }
  panelNo.classList.add('hide');
  const groupExp = groupBy(exps, x=> mapCat[x.category_id] || 'อื่น ๆ');
  const labels = Object.keys(groupExp);
  const data = labels.map(k=> sum(groupExp[k], x=> x.amount));
  chartExp = new Chart($('#chartExp'), {
    type:'bar',
    data:{ labels, datasets:[{ label:'จำนวน (บาท)', data, backgroundColor:'rgba(233,30,99,0.65)', borderColor:'rgba(233,30,99,1)', borderWidth:1 }] },
    options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true }}, plugins:{ legend:{ display:false } } }
  });
}
function drawFlow(items){
  const panelNo = $('#noDataFlow'); if (chartFlow) chartFlow.destroy();
  if (!items.length){ panelNo.classList.remove('hide'); chartFlow=null; return; }
  panelNo.classList.add('hide');
  const g = groupBy(items, x=> x.date);
  const ds = Object.keys(g).sort();
  const income  = ds.map(d=> sum(g[d], x=> x.type==='income'?  x.amount:0));
  const expense = ds.map(d=> sum(g[d], x=> x.type==='expense'? x.amount:0));
  const savingD = ds.map(d=> sum(g[d], x=> x.type==='saving'?  x.amount:0));
  const netDaily = ds.map((_,i)=> income[i] - expense[i] - savingD[i]);
  const netCumulative = runningSum(netDaily);
  chartFlow = new Chart($('#chartFlow'), {
    type:'line',
    data:{ labels: ds,
      datasets:[
        { label:'รายรับ', data:income, borderColor:'#00c896', backgroundColor:'rgba(0,200,150,.15)', tension:.35, fill:false },
        { label:'รายจ่าย', data:expense, borderColor:'#ff4d4f', backgroundColor:'rgba(255,77,79,.15)', tension:.35, fill:false },
        { label:'คงเหลือสะสม', data:netCumulative, borderColor:'#6c8cff', backgroundColor:'rgba(108,140,255,.15)', tension:.35, fill:false }
      ]
    },
    options:{ responsive:true, maintainAspectRatio:false, animation:false, interaction:{ mode:'index', intersect:false }, scales:{ y:{ beginAtZero:true } } }
  });
}
function drawSavingCum(items){
  const panelNo = $('#noDataSav'); if (chartSavCum) chartSavCum.destroy();
  const byDateDep = groupBy(items.filter(x=>x.type==='saving'), x=> x.date);
  const byDateWdr = groupBy(items.filter(x=> x.type==='income' && withdrawIncomeIds.has(x.category_id)), x=> x.date);
  const dates = Array.from(new Set([...Object.keys(byDateDep), ...Object.keys(byDateWdr)])).sort();
  if (!dates.length){ panelNo.classList.remove('hide'); chartSavCum=null; return; }
  panelNo.classList.add('hide');
  const netPerDay = dates.map(d=>{
    const dep = sum(byDateDep[d]||[], x=> x.amount);
    const wdr = sum(byDateWdr[d]||[], x=> x.amount);
    return dep - wdr;
  });
  const cum = runningSum(netPerDay);
  chartSavCum = new Chart($('#chartSavCum'), {
    type:'line',
    data:{ labels: dates, datasets:[{ label:'ออมสุทธิสะสม', data:cum, borderColor:'#2dd4bf', backgroundColor:'rgba(45,212,191,.15)', tension:.35, fill:false }] },
    options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true }}}
  });
}

/** ====== Debt charts (รับข้อมูลที่ดึงมาแล้ว) ====== */
function dateRangeArray(from, to){
  const out = []; const df = new Date(from), dt = new Date(to);
  if (isNaN(df)||isNaN(dt) || df>dt) return out;
  for (let d=new Date(df); d<=dt; d=new Date(d.getFullYear(), d.getMonth(), d.getDate()+1)){ out.push(toYMD(d)); }
  return out;
}
function drawDebtNetTotalOverTime(end, rDebts, rTx){
  const panelNo = $('#noDataDebtTS'); if (chartDebtTS) chartDebtTS.destroy();
  const from = $('#fFrom').value || end;
  const days = dateRangeArray(from, end);
  if (!days.length || !rDebts.ok){ panelNo.classList.remove('hide'); chartDebtTS=null; return; }

  const base = (rDebts.items||[]).map(x=>({
    id:String(x.debt_id), rate:Number(x.annual_rate||0),
    principal:Number(x.principal_current||0), accrued:Number(x.accrued_interest||0)
  }));
  const txs = (rTx.ok ? (rTx.items||[]) : []).map(t=>({
    date:String(t.date||'').slice(0,10), id:String(t.debt_id||''), type:String(t.type||''), prin:+(t.principal_paid||0), intr:+(t.interest_paid||0), amt:+(t.amount||0)
  }));
  const byDateId = {};
  for (const t of txs){ (byDateId[`${t.date}__${t.id}`] ||= []).push(t); }

  const ONE = r => (Number(r)/100)/365;
  const states = base.map(b=> ({...b}));
  const daily = [];
  for (const day of days){
    for (const s of states){ if (s.principal>0) s.accrued += s.principal * ONE(s.rate); }
    for (const s of states){
      const list = byDateId[`${day}__${s.id}`] || [];
      for (const t of list){
        if (t.type==='borrow'){ s.principal += t.amt; }
        else if (t.type==='repay'){ s.accrued = Math.max(0, s.accrued - t.intr); s.principal = Math.max(0, s.principal - t.prin); }
      }
    }
    daily.push(states.reduce((sum,x)=> sum + x.principal + x.accrued, 0));
  }
  if (!daily.some(v => v>0)){ panelNo.classList.remove('hide'); chartDebtTS=null; return; }
  panelNo.classList.add('hide');
  chartDebtTS = new Chart($('#chartDebtTS'), { type:'line',
    data:{ labels: days, datasets:[{ label:'ยอดหนี้คงเหลือรวมสุทธิ', data:daily, borderColor:'#6c8cff', backgroundColor:'rgba(108,140,255,.15)', tension:.35, fill:false }] },
    options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true } } }
  });
}
function drawPrincipalInterestMonthly(r){
  const panelNo = $('#noDataPI'); if (chartPI) chartPI.destroy();
  if (!r.ok || !(r.items||[]).length){ panelNo.classList.remove('hide'); chartPI=null; return; }
  panelNo.classList.add('hide');
  const g = {};
  for (const x of r.items){
    if (String(x.type)!=='repay') continue;
    const ym = String(x.date||'').slice(0,7);
    (g[ym] ||= { prin:0, intr:0 });
    g[ym].prin += Number(x.principal_paid||0);
    g[ym].intr += Number(x.interest_paid||0);
  }
  const labels = Object.keys(g).sort(); if (!labels.length){ panelNo.classList.remove('hide'); chartPI=null; return; }
  const prin = labels.map(m=> g[m].prin);
  const intr = labels.map(m=> g[m].intr);
  chartPI = new Chart($('#chartPI'), { type:'line',
    data:{ labels, datasets:[
      { label:'จ่ายต้น (บาท)', data:prin, borderColor:'#00c896', backgroundColor:'rgba(0,200,150,.15)', tension:.35, fill:false },
      { label:'จ่ายดอก (บาท)', data:intr, borderColor:'#ffb020', backgroundColor:'rgba(255,176,32,.15)', tension:.35, fill:false },
    ]},
    options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{ y:{ beginAtZero:true } } }
  });
}

/** ====== EVENTS ====== */
document.querySelectorAll('.chip[data-range]').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    const k = ch.dataset.range;
    if (k==='today'){ const d=todayISO(); setRange(d,d); }
    if (k==='7') setRangeDaysBack(7);
    if (k==='30') setRangeDaysBack(30);
    if (k==='month'){ const mb=monthBounds(new Date()); setRange(mb.start, mb.end); }
    if (k==='year'){ const y=new Date().getFullYear(); setRange(`${y}-01-01`, `${y}-12-31`); }
  });
});
$('#fFrom').addEventListener('change', ()=>{ updateRangeUI(); refreshDash(); });
$('#fTo').addEventListener('change', ()=>{ updateRangeUI(); refreshDash(); });
$('#btnRefresh').addEventListener('click', (e)=> withBusy(e.currentTarget, ()=>refreshDash()));
$('#btnSaveBudget').addEventListener('click', async (e)=>{
  const btn = e.currentTarget;
  const mk = monthKeyFromRange();
  const ok = await withBusy(btn, ()=> saveMonthSettings(mk, $('#budgetThisMonth').value, $('#savingGoalThisMonth').value), 'กำลังบันทึก…');
  if (ok) refreshDash(true);
});

/** ====== INIT ====== */
(async function init(){
  const mb = monthBounds(new Date()); $('#fFrom').value = mb.start; $('#fTo').value = mb.end; updateRangeUI();

  showOverlay(true); // overlay เฉพาะตอนเริ่ม LIFF
  let ok = false;
  try{ ok = await ensureTokenViaLIFF(); }catch(e){ console.error(e); toast('เริ่มต้นผ่าน LIFF ไม่สำเร็จ', false); }
  showOverlay(false);

  if (ok){
    await loadCategoriesAll();   // พร้อมกันภายใน
    refreshDash(true);           // โหลดทุกอย่างแบบ parallel
  }
})();
</script>
</body>
</html>
