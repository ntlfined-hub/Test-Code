<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FIN-JOD ¬∑ Hybrid Tabs (‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î)</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">

  <!-- Warmup -->
  <link rel="dns-prefetch" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://static.line-scdn.net" crossorigin>
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>

  <style>
    :root{
      --bg:#1e1e1e; --panel:#242424; --line:#3a3a3a; --muted:#bfbfbf; --text:#f1f1f1;
      --primary:#00c896; --danger:#ff4d4f; --blue:#6c8cff; --warn:#ffb020; --cyan:#2dd4bf;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; padding:clamp(.75rem,2vw,1.25rem);
      padding-bottom:calc(clamp(.75rem,2vw,1.25rem) + env(safe-area-inset-bottom,0px));
      font-family:'Kanit', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      background:var(--bg); color:var(--text)
    }
    .wrap{ width:min(1140px,100%); margin:auto; background:var(--panel); border:1px solid var(--line);
      border-radius:20px; padding:clamp(1rem,2.2vw,1.5rem) }
    h1{ margin:.25rem 0 1rem; font-size:clamp(1.25rem,4.5vw,1.8rem); color:var(--primary); text-align:center }
    .head{ display:flex; align-items:center; gap:.75rem; margin-bottom:.75rem }
    .head .you{ margin-left:auto; color:#9fe9d4; font-weight:600 }

    .tabs{ display:flex; gap:.5rem; background:#1b1b1b; border:1px solid var(--line); border-radius:12px; padding:.25rem; margin-bottom:1rem }
    .tab-btn{ flex:1; padding:.7rem 1rem; border-radius:10px; border:1px solid transparent; background:transparent; color:#ddd; font-weight:700; cursor:pointer }
    .tab-btn.active{ background:#2a2a2a; border-color:#3a2a3a; color:#fff }
    .tab-pane{ display:none }
    .tab-pane.active{ display:block }

    .card{ background:#1f1f1f; border:1px solid var(--line); border-radius:16px; padding:1rem; margin-bottom:1rem }
    .row{ display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1rem }
    .col{ flex:1 1 46%; min-width:230px; display:flex; flex-direction:column; gap:.35rem }
    label{ color:var(--muted) }

    input,select,button{
      border-radius:12px; border:1px solid var(--line);
      background:#1d1d1d; color:#fff; min-height:44px; padding:.9rem 1rem; font-size:16px
    }
    input[type=number]{ text-align:right; -moz-appearance:textfield }
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }

    button{ background:var(--primary); border:none; font-weight:700; cursor:pointer; position:relative }
    button:disabled{ opacity:.65; cursor:not-allowed }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î */
    button[aria-busy="true"]{ pointer-events:none }
    button[aria-busy="true"]::after{
      content:""; position:absolute; right:10px; top:50%; transform:translateY(-50%);
      width:18px; height:18px; border-radius:50%;
      border:3px solid #3a3a3a; border-top-color:#fff; animation:spin 1s linear infinite;
    }

    .btn-ghost{ background:#333 } .btn-blue{ background:var(--blue) } .btn-warn{ background:var(--warn); color:#222 }
    .btn-danger{ background:var(--danger) } .btn-cyan{ background:var(--cyan); color:#052a27 } .btn-green{ background:var(--primary) }

    .seg{ display:flex; gap:.5rem; flex-wrap:wrap }
    .seg button{ background:#333 }
    .seg button.active{ background:var(--primary); color:#052a27 }

    .muted{ color:var(--muted) }
    .right{ text-align:right }

    table{ width:100%; border-collapse:collapse; table-layout:fixed; font-size:.98rem }
    th,td{ border-bottom:1px solid var(--line); padding:.8rem .5rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:middle }
    th{ color:var(--muted); font-weight:600; text-align:left; position:sticky; top:0; background:#1f1f1f; z-index:1 }
    .table-viewport{ max-height:72vh; overflow:auto; border-radius:12px; border:1px solid var(--line) }
    .table-viewport tbody tr:hover{ background:#2a2a2a }
    td:last-child .actions{ display:flex; gap:.5rem; flex-wrap:wrap }

    .badge{ padding:.25rem .5rem; border-radius:999px; font-size:.85rem }
    .badge-inc{ background:rgba(0,200,150,.18); color:#9ff3df; border:1px solid rgba(0,200,150,.35) }
    .badge-exp{ background:rgba(233,30,99,.15); color:#ffb6cc; border:1px solid rgba(233,30,99,.35) }
    .badge-sav{ background:rgba(45,212,191,.16); color:#a7fff0; border:1px solid rgba(45,212,191,.35) }
    .badge-debt{ background:rgba(108,140,255,.16); color:#c8d2ff; border:1px solid rgba(108,140,255,.35) }

    #toast{ position:fixed; left:50%; bottom:calc(18px + env(safe-area-inset-bottom,0px)); transform:translateX(-50%);
      background:#333; color:#fff; padding:.6rem .9rem; border-radius:10px; opacity:0; transition:opacity .25s; pointer-events:none; z-index:120 }

    #overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:110; transition:opacity .2s }
    #overlay.hide{ opacity:0; pointer-events:none }
    .spinner{ width:42px; height:42px; border-radius:50%; border:5px solid #3a3a3a; border-top-color:#fff; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:150 }
    .modal-backdrop.show{ display:flex }
    .modal{ width:min(640px,96vw); background:#242424; border:1px solid var(--line); border-radius:16px; padding:1rem 1rem 1.25rem }
    .modal .title{ font-weight:700; margin-bottom:.75rem }
    .modal .actions{ display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem }

    .help{ font-size:.9rem; color:var(--muted) }
    .hide{ display:none }
  </style>

  <!-- LIFF SDK -->
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <h1 style="margin:0">FIN-JOD ¬∑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h1>
      <div class="you" id="who"></div>
    </div>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ -->
    <div id="linkBox" class="card hide" role="region" aria-label="‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">
      <div class="muted" style="margin-bottom:.5rem">‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô LINE ‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      <div class="row">
        <div class="col"><label for="inpUser">User ID</label><input id="inpUser" placeholder="‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"/></div>
        <div class="col"><label for="inpPin">PIN</label><input id="inpPin" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™"/></div>
      </div>
      <div style="display:flex; gap:.5rem; justify-content:flex-end">
        <button id="btnLink" class="btn-ghost">‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
      </div>
    </div>

    <!-- ‡πÅ‡∏≠‡∏õ + ‡πÅ‡∏ó‡πá‡∏ö -->
    <div id="app" class="hide">
      <div class="tabs" role="tablist" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å">
        <button id="tab-create" class="tab-btn active" role="tab" aria-selected="true" aria-controls="pane-create">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button id="tab-list"   class="tab-btn"        role="tab" aria-selected="false" aria-controls="pane-list">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>

      <!-- ‡πÅ‡∏ó‡πá‡∏ö 1: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
      <section id="pane-create" class="tab-pane active" role="tabpanel" aria-labelledby="tab-create">
        <div class="card" role="region" aria-label="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°">
          <div class="row">
            <div class="col">
              <label for="txDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input id="txDate" type="date" />
            </div>
            <div class="col">
              <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
              <div class="seg">
                <button class="segbtn" data-type="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
                <button class="segbtn" data-type="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
                <button class="segbtn" data-type="saving">‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</button>
                <span class="muted" style="align-self:center">|</span>
                <button class="segbtn" data-type="debt_repay" title="‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ">‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ</button>
                <button class="segbtn" data-type="debt_borrow" title="‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ">‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ</button>
              </div>
              <select id="txType" class="hide" aria-hidden="true">
                <option value="expense" selected>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                <option value="saving">‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</option>
                <option value="debt_repay">‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ</option>
                <option value="debt_borrow">‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ</option>
              </select>
            </div>

            <div class="col" id="colCat">
              <label for="txCat">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
              <select id="txCat" disabled><option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</option></select>
              <div class="help">* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°</div>
            </div>
            <div class="col" id="colAmount">
              <label for="txAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
              <input id="txAmount" type="number" step="0.01" inputmode="decimal" placeholder="0.00" />
            </div>

            <div class="col hide" id="colDebt">
              <label for="txDebt">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</label>
              <div class="row" style="margin:0; gap:.5rem">
                <div class="col" style="min-width:200px"><select id="txDebt" disabled><option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</option></select></div>
              </div>
              <div class="help">* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</div>
            </div>
            <div class="col hide" id="colDebtRepayFields" style="flex:1 1 100%">
              <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ</label>
              <div class="row" style="gap:.5rem; margin:0">
                <div class="col"><input id="txInt" type="number" step="0.01" placeholder="‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å (‡∏ö‡∏≤‡∏ó)" /></div>
                <div class="col"><input id="txPrin" type="number" step="0.01" placeholder="‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)" /></div>
              </div>
              <div class="help">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° = ‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å + ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô</div>
            </div>
          </div>

          <div class="row" style="align-items:flex-end; gap:1rem">
            <div class="col" style="flex:1 1 0">
              <label for="txNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <input id="txNote" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" maxlength="500" />
            </div>
            <div class="col" style="flex:0 0 auto; display:flex; gap:.5rem">
              <button id="btnPrefetchCreate" class="btn-cyan" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏°‡∏ß‡∏î/‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
              <button id="btnSave" class="btn-green" style="min-width:180px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            </div>
          </div>
        </div>

        <!-- ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
        <div class="card" role="region" aria-label="‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
          <div class="muted" style="margin-bottom:.5rem">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
          <div class="table-viewport" id="recentBox">
            <table>
              <thead>
                <tr>
                  <th style="width:110px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th style="width:140px">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th>‡∏´‡∏°‡∏ß‡∏î/‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</th>
                  <th class="right" style="width:130px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr>
              </thead>
              <tbody id="recentBody">
                <tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ‡πÅ‡∏ó‡πá‡∏ö 2: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
      <section id="pane-list" class="tab-pane" role="tabpanel" aria-labelledby="tab-list">
        <div class="card" role="region" aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á">
          <div class="row">
            <div class="col"><label for="fFrom">‡∏à‡∏≤‡∏Å</label><input id="fFrom" type="date" /></div>
            <div class="col"><label for="fTo">‡∏ñ‡∏∂‡∏á</label><input id="fTo" type="date" /></div>
            <div class="col">
              <label>&nbsp;</label>
              <div class="seg">
                <button class="chip" data-range="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                <button class="chip" data-range="7">7 ‡∏ß‡∏±‡∏ô</button>
                <button class="chip" data-range="30">30 ‡∏ß‡∏±‡∏ô</button>
                <button class="chip" data-range="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
                <button class="chip" data-range="year">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</button>
                <button id="btnRefresh" class="btn-blue" style="margin-left:auto">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
              </div>
              <div class="muted" style="margin-top:.4rem">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π: <b id="rangeBadge">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</b></div>
            </div>
          </div>

          <div class="table-viewport">
            <table>
              <thead>
                <tr>
                  <th style="width:110px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th style="width:140px">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th>‡∏´‡∏°‡∏ß‡∏î/‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ</th>
                  <th class="right" style="width:130px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                  <th style="width:160px">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="tblBody">
                <tr><td colspan="6" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
              </tbody>
            </table>
          </div>
          <div id="emptyList" class="muted" style="margin-top:.5rem; display:none">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>
      </section>
    </div>
  </div>

  <!-- ‡πÇ‡∏°‡∏î‡∏±‡∏•‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
  <div id="editBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
      <div id="editTitle" class="title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
      <input id="editTxId" type="hidden">

      <div class="row">
        <div class="col"><label for="editDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="editDate" type="date"></div>

        <div class="col" id="editColType">
          <label for="editType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
          <select id="editType">
            <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
            <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
            <option value="saving">‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</option>
          </select>
        </div>

        <div class="col" id="editColCat"><label for="editCat">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select id="editCat"></select></div>

        <div class="col" id="editColAmount">
          <label for="editAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
          <input id="editAmount" type="number" step="0.01" placeholder="0.00">
        </div>

        <div class="col hide" id="editColDebtRepayFields" style="flex:1 1 100%">
          <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ</label>
          <div class="row" style="gap:.5rem; margin:0">
            <div class="col"><input id="editInt" type="number" step="0.01" placeholder="‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å (‡∏ö‡∏≤‡∏ó)"></div>
            <div class="col"><input id="editPrin" type="number" step="0.01" placeholder="‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô (‡∏ö‡∏≤‡∏ó)"></div>
          </div>
          <div class="help">* ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° = ‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å + ‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</div>
        </div>

        <div class="col" style="flex:1 1 100%"><label for="editNote">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input id="editNote" maxlength="500" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></div>
      </div>

      <div class="actions">
        <button id="btnDelete" class="btn-danger">‡∏•‡∏ö</button>
        <button id="btnCancel" class="btn-ghost">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="btnUpdate" class="btn-warn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      </div>
    </div>
  </div>

  <div id="toast">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
  <div id="overlay" class="hide" aria-live="polite" aria-busy="true"><div class="spinner"></div></div>

<script>
/** ====== CONFIG ====== */
const LIFF_ID = '2008276151-Oyp12d62';
const API_URL = 'https://script.google.com/macros/s/AKfycbxV3xOU1kQM86jUJtfer8hW_HgYkcLfpH942saPVbCZ1RDmN_4LYjpk72OxdKKLQAFt/exec';

/** ====== STATE ====== */
let token = localStorage.getItem('fin_token') || '';
let displayName = localStorage.getItem('fin_name') || '';
let lastItems = [];
let cats = { income:[], expense:[], saving:[] };
let debtsCache = [];
const loaded = { create:false, list:false };
const THB = new Intl.NumberFormat('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2});
let recentItems = []; // ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
const cacheTTL = { cats: 24*60*60*1000, debts: 10*60*1000 };
let listDirty = false; // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à -> ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

/** ====== HELPERS ====== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => THB.format(Number(n||0));
const esc = s => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
const toast = (msg, ok=true)=>{ const el=$('#toast'); el.textContent=msg; el.style.background= ok?'#00c896':'#ff4d4f'; el.style.opacity='1'; setTimeout(()=> el.style.opacity='0', 2200); };
const toYMD = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const todayISO = ()=> toYMD(new Date());
const monthBounds = d => ({ start: toYMD(new Date(d.getFullYear(), d.getMonth(), 1)), end: toYMD(new Date(d.getFullYear(), d.getMonth()+1, 0)) });
const debounce = (fn,ms=300)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };

function setBusy(btn, on, tempText){
  if (!btn) return;
  if (on){
    btn.dataset._text = btn.textContent;
    if (tempText) btn.textContent = tempText;
    btn.setAttribute('aria-busy','true'); btn.disabled = true;
  }else{
    btn.disabled = false; btn.removeAttribute('aria-busy');
    if (btn.dataset._text){ btn.textContent = btn.dataset._text; delete btn.dataset._text; }
  }
}
async function withBusy(btn, fn, textWhile='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶'){
  setBusy(btn, true, textWhile);
  try{ return await fn(); } finally{ setBusy(btn, false); }
}
async function fetchJSON(url, options={}){
  try{
    const res = await fetch(url, { ...options, headers:{'Content-Type':'text/plain;charset=utf-8', ...(options.headers||{})} });
    const text = await res.text(); try { return JSON.parse(text); } catch{ return { ok:false, error:'NON_JSON', raw:text }; }
  }catch(e){ return { ok:false, error:'NETWORK', message:String(e&&e.message||e) }; }
}
async function api(path, payload={}, useToken=true){
  const body = { path, payload }; if (useToken && token) body.token = token;
  return fetchJSON(API_URL, { method:'POST', body: JSON.stringify(body) });
}
function cacheGet(k){
  const raw = localStorage.getItem(k); if(!raw) return null;
  try{ const {exp,data} = JSON.parse(raw); if (Date.now()>exp){ localStorage.removeItem(k); return null; } return data; }catch{ return null; }
}
function cacheSet(k,data,ttl){ localStorage.setItem(k, JSON.stringify({exp:Date.now()+ttl, data})); }

/** ====== LIFF ====== */
function waitForLiffReady(timeoutMs=5000){
  return new Promise(res=>{
    if (window.liff){ return res(true); }
    const t0=Date.now(), iv=setInterval(()=>{ if (window.liff){ clearInterval(iv); res(true); } else if(Date.now()-t0>timeoutMs){ clearInterval(iv); res(false); } },30);
  });
}
async function ensureTokenViaLIFF(){
  const okReady = await waitForLiffReady();
  if (!okReady){ toast('LIFF ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä', false); return false; }
  try{ await liff.init({ liffId: LIFF_ID }); }catch{ toast('‡πÄ‡∏£‡∏¥‡πà‡∏° LIFF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); return false; }
  if (!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return false; }

  let prof; try{ prof = await liff.getProfile(); }catch{ toast('‡∏≠‡πà‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', false); return; }
  const r = await api('liff/link_or_login', { line_user_id: prof.userId, display_name: prof.displayName||'' }, false);
  if (!r.ok){ toast(r.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', false); return false; }

  if (r.need_verification){
    $('#who').textContent = prof.displayName || '';
    $('#linkBox').classList.remove('hide'); $('#app').classList.add('hide');
    return false;
  }
  token = r.token; displayName = r.display_name || prof.displayName || '';
  localStorage.setItem('fin_token', token); localStorage.setItem('fin_name', displayName);
  $('#who').textContent = displayName;
  $('#linkBox').classList.add('hide'); $('#app').classList.remove('hide');
  return true;
}
$('#btnLink')?.addEventListener('click', async (e)=>{
  const btn=e.currentTarget;
  const user_id=$('#inpUser').value.trim(); const pin=$('#inpPin').value.trim();
  if (!user_id || !pin){ toast('‡∏Å‡∏£‡∏≠‡∏Å User ‡πÅ‡∏•‡∏∞ PIN ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', false); return; }
  let prof; try{ prof=await liff.getProfile(); }catch{ toast('‡∏≠‡πà‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', false); return; }
  const r = await withBusy(btn, ()=> api('liff/link_or_login',{ line_user_id:prof.userId, display_name:prof.displayName||'', user_id, pin }, false), '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‚Ä¶');
  if (!r.ok){ toast(r.message||'‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); return; }
  token=r.token; displayName=r.display_name||user_id;
  localStorage.setItem('fin_token', token); localStorage.setItem('fin_name', displayName);
  $('#who').textContent = displayName; $('#linkBox').classList.add('hide'); $('#app').classList.remove('hide');
});

/** ====== Categories / Debts (‡πÅ‡∏Ñ‡∏ä + ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô) ====== */
async function loadCategoriesAll(){
  const cache = cacheGet('fin_cats_v1');
  if (cache){
    cats = cache;
    // üîß FIX: ‡∏õ‡∏•‡∏î disable ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä
    $('#txCat').disabled = false;
    populateCatSelect();
    return;
  }
  $('#txCat').disabled = true; $('#txCat').innerHTML = '<option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</option>';
  const types=['income','expense','saving'];
  const [ri,re,rs]=await Promise.all(types.map(t=> api('categories/list',{type:t},true)));
  cats={ income:ri.ok?(ri.items||[]):[], expense:re.ok?(re.items||[]):[], saving:rs.ok?(rs.items||[]):[] };
  cacheSet('fin_cats_v1', cats, cacheTTL.cats);
  $('#txCat').disabled = false; populateCatSelect();
}
async function loadDebtsList(){
  const cache = cacheGet('fin_debts_v1');
  if (cache){ debtsCache = cache; fillSelect($('#txDebt'), debtsCache, d=>d.debt_id, d=>d.lender_name||d.debt_id); $('#txDebt').disabled=false; return; }
  $('#txDebt').disabled=true; $('#txDebt').innerHTML='<option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</option>';
  const r=await api('debts/list', {}, true);
  debtsCache = r.ok?(r.items||[]):[];
  cacheSet('fin_debts_v1', debtsCache, cacheTTL.debts);
  fillSelect($('#txDebt'), debtsCache, d=>d.debt_id, d=>d.lender_name||d.debt_id);
  $('#txDebt').disabled=false;
}
function fillSelect(el, items, getVal, getText){
  const frag=document.createDocumentFragment();
  for(const it of items){ const o=document.createElement('option'); o.value=getVal(it); o.textContent=getText(it); frag.appendChild(o); }
  el.innerHTML=''; el.appendChild(frag);
}
function populateCatSelect(){
  const t=$('#txType').value; const list=(cats[t]||[]);
  if (!list.length) $('#txCat').innerHTML='<option value="">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î ‚Äî</option>';
  else fillSelect($('#txCat'), list, c=>c.category_id, c=>c.name_th||c.category_id);
}

/** ====== Type Switch ====== */
function setType(type){
  $('#txType').value = type;
  $$('.segbtn').forEach(b=> b.classList.toggle('active', b.dataset.type===type));
  const debtMode = (type==='debt_repay' || type==='debt_borrow');
  const isRepay = (type==='debt_repay');
  $('#colCat').classList.toggle('hide', debtMode);
  $('#colAmount').classList.toggle('hide', isRepay && debtMode);
  $('#colDebt').classList.toggle('hide', !debtMode);
  $('#colDebtRepayFields').classList.toggle('hide', !isRepay);
  if (!debtMode) populateCatSelect();
}

/** ====== ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ====== */
function normalizeTypeBadge(x){
  const isDebt = (x._kind==='debt_repay' || x._kind==='debt_borrow');
  if (isDebt) return { cls:'badge-debt', text:(x._kind==='debt_repay'?'‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ':'‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ') };
  if (x.type==='income') return { cls:'badge-inc', text:'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' };
  if (x.type==='saving') return { cls:'badge-sav', text:'‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô' };
  return { cls:'badge-exp', text:'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' };
}
// üîß ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ó‡πá‡∏Å‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å API ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏π‡πâ/‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
function annotateForRecent(it){
  const isDebt = !!(it.debt_tx_id || it.type==='debt' || (it.category_name||'').includes('‡∏´‡∏ô‡∏µ‡πâ'));
  let _kind = null;
  if (isDebt){
    const flagRepay = String(it.sub_type||it.debt_type||'').includes('repay') || /‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ|‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ/i.test(it.note||'');
    _kind = flagRepay ? 'debt_repay' : 'debt_borrow';
  }
  return { ...it, _kind };
}
function renderRecent(){
  const tb = $('#recentBody'); tb.innerHTML='';
  if (!recentItems.length){ tb.innerHTML='<tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>'; return; }
  const frag=document.createDocumentFragment();
  for (const x of recentItems.slice(0,5)){
    const { cls, text } = normalizeTypeBadge(x);
    const catName = x._kind?.startsWith('debt') ? (x.lender_name||x.category_name||'‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ') : (x.category_name||x.cat_name||x.category_id||'');
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${esc((x.date||'').slice(0,10))}</td>
      <td><span class="badge ${cls}">${text}</span></td>
      <td>${esc(catName)}</td>
      <td class="right">${fmt(+x.amount||0)}</td>
      <td>${esc(x.note||'')}</td>`;
    frag.appendChild(tr);
  }
  tb.appendChild(frag);
}
async function loadRecentFromAPI(){
  const to=todayISO();
  const d=new Date(); d.setDate(d.getDate()-13);
  const from=toYMD(d);
  const r = await api('transactions/list', { from, to, type:'all' }, true);
  if (!r.ok){ renderRecent(); return; }
  const arr = (r.items||[]).map(it=>({ ...annotateForRecent(it), amount:+it.amount }));
  arr.sort((a,b)=> (String(b.date||'')+String(b.time||'')).localeCompare(String(a.date||'')+String(a.time||'')));
  recentItems = arr.slice(0,5);
  renderRecent();
}

/** ====== Save Transaction ====== */
function normalizeAmount(v){ const n=Number(v); return (isFinite(n) && n>0) ? Math.round(n*100)/100 : NaN; }
function clearFormKeepDate(){
  $('#txAmount').value=''; $('#txNote').value='';
  $('#txInt').value=''; $('#txPrin').value='';
}
async function saveTx(ev){
  const btn = ev.currentTarget;
  const type = $('#txType').value;
  const date = $('#txDate').value;
  const note = $('#txNote').value.trim();
  if (!date){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', false); return; }
  if (!token){ toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (LIFF)', false); return; }

  await withBusy(btn, async ()=>{
    if (type==='debt_repay' || type==='debt_borrow'){
      const debt_id = $('#txDebt').value;
      if (!debt_id){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ', false); return; }

      if (type==='debt_repay'){
        const interest = Number($('#txInt').value||0);
        const principal = Number($('#txPrin').value||0);
        const amount = Math.round((interest + principal) * 100)/100;
        if (!(isFinite(amount) && amount>0)){ toast('‡πÉ‡∏™‡πà‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≠‡∏Å/‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); return; }
        const r = await api('debts/repay', { debt_id, date, amount, interest_paid:interest, principal_paid:principal, note }, true);
        if (r.ok){
          toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          recentItems.unshift({ _kind:'debt_repay', date, amount, note, lender_name:(debtsCache.find(d=>String(d.debt_id)===String(debt_id))?.lender_name)||'' });
          recentItems = recentItems.slice(0,5); renderRecent();
          listDirty = true;
          clearFormKeepDate(); $('#txAmount').focus();
        } else toast(r.message||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
        return;
      }else{
        const amount = normalizeAmount($('#txAmount').value);
        if (isNaN(amount)){ toast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); return; }
        const r = await api('debts/borrow', { debt_id, date, amount, note }, true);
        if (r.ok){
          toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          recentItems.unshift({ _kind:'debt_borrow', date, amount, note, lender_name:(debtsCache.find(d=>String(d.debt_id)===String(debt_id))?.lender_name)||'' });
          recentItems = recentItems.slice(0,5); renderRecent();
          listDirty = true;
          clearFormKeepDate(); $('#txAmount').focus();
        } else toast(r.message||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
        return;
      }
    }

    // income/expense/saving
    const amount = normalizeAmount($('#txAmount').value);
    const category_id = $('#txCat').value;
    if (isNaN(amount)){ toast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); return; }
    if (!category_id){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î', false); return; }

    const payload = { date, type, category_id, amount, note };
    const r = await api('transactions/create', payload, true);
    if (r.ok){
      toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      const catName = (cats[type]||[]).find(c=>String(c.category_id)===String(category_id))?.name_th || '';
      recentItems.unshift({ date, type, amount, note, cat_name:catName, category_id });
      recentItems = recentItems.slice(0,5); renderRecent();
      listDirty = true;
      clearFormKeepDate(); $('#txAmount').focus();
    } else toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
  }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶');
}
$('#btnSave').addEventListener('click', saveTx);

/** ====== ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (‡πÅ‡∏ó‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ====== */
function safeKey(x){ return `${(x.date||'').slice(0,10)}T${(x.time||'00:00:00').slice(0,8)}`; }
function renderTable(items){
  const tb = $('#tblBody'); tb.innerHTML='';
  const sorted = items.slice().sort((a,b)=> safeKey(b).localeCompare(safeKey(a)));
  $('#emptyList').style.display = sorted.length? 'none':'block';
  const catMap = {}; [...(cats.expense||[]), ...(cats.income||[]), ...(cats.saving||[])]
    .forEach(c=> catMap[c.category_id]=c.name_th);

  const frag = document.createDocumentFragment();
  for (const x of sorted){
    const isDebtTx = (x.debt_tx_id || x.type==='debt' || (x.category_name||'').includes('‡∏´‡∏ô‡∏µ‡πâ'));
    const isRepay = isDebtTx && (String(x.sub_type||'repay').includes('repay') || (x.note||'').includes('‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ'));
    const badge = isDebtTx ? 'badge-debt' : (x.type==='income' ? 'badge-inc' : (x.type==='saving'?'badge-sav':'badge-exp'));
    const typeTxt = isDebtTx ? (isRepay?'‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ':'‡∏Å‡∏π‡πâ‡∏´‡∏ô‡∏µ‡πâ') : (x.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':(x.type==='saving'?'‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'));
    const catName = isDebtTx ? (x.lender_name || x.category_name || '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ') : (catMap[x.category_id] || x.category_name || x.category_id || '');

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td title="${esc((x.date||'').slice(0,10))}">${esc((x.date||'').slice(0,10))}</td>
      <td><span class="badge ${badge}">${typeTxt}</span></td>
      <td>${esc(catName)}</td>
      <td class="right">${fmt(+x.amount||0)}</td>
      <td>${esc(x.note||'')}</td>
      <td>
        <div class="actions">
          <button class="btn-ghost" data-act="edit" data-id="${esc(x.tx_id||'')}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn-danger" data-act="del"  data-id="${esc(x.tx_id||'')}">‡∏•‡∏ö</button>
        </div>
      </td>`;
    frag.appendChild(tr);
  }
  tb.appendChild(frag);
}
async function refreshList(btn){
  if (!token) return;
  const from=$('#fFrom').value, to=$('#fTo').value;
  if (btn) setBusy(btn, true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶'); else $('#tblBody').innerHTML = '<tr><td colspan="6" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</td></tr>';
  const r = await api('transactions/list', { from, to, type:'all' }, true);
  if (btn) setBusy(btn, false);
  if (!r.ok){ toast('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); return; }
  lastItems = (r.items||[]).map(x=> ({...x, amount:+x.amount}));
  renderTable(lastItems);
}

// ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á busy ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏•‡∏î modal
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('#tblBody button[data-act]');
  if (!btn) return;
  const id = btn.getAttribute('data-id');
  const act = btn.getAttribute('data-act');
  if (act==='edit'){
    setBusy(btn, true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‚Ä¶');
    openEditById(id).finally(()=> setBusy(btn,false));
  }
  if (act==='del')  confirmDelete(id, btn);
});

/** ====== Edit/Delete ====== */
async function openEditById(txId){
  if (!txId){ toast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', false); return; }
  let it = lastItems.find(x=> String(x.tx_id)===String(txId));
  if (!it){
    const r = await api('transactions/list', { from: $('#fFrom').value, to: $('#fTo').value, type:'all' }, true);
    if (!r.ok){ toast('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); return; }
    lastItems = (r.items||[]); it = lastItems.find(x=> String(x.tx_id)===String(txId));
    if (!it){ toast('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', false); return; }
  }
  const isDebtRepay = !!it.debt_tx_id && (String(it.debt_type||'repay').includes('repay') || (it.category_name||'').includes('‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡∏µ‡πâ'));
  $('#editTxId').value = it.tx_id;
  $('#editDate').value = (it.date||'').slice(0,10);
  $('#editNote').value = it.note||'';

  if (isDebtRepay){
    $('#editColType').classList.add('hide');
    $('#editColCat').classList.add('hide');
    $('#editColAmount').classList.remove('hide');
    $('#editColDebtRepayFields').classList.remove('hide');
    $('#editAmount').readOnly = true;
    $('#editType').disabled = true; $('#editCat').disabled = true;

    const debtDetails = await api('debts/tx/get', { tx_id: it.debt_tx_id }, true);
    const prin = debtDetails.ok ? Number(debtDetails.item?.principal_paid||0) : 0;
    const intr = debtDetails.ok ? Number(debtDetails.item?.interest_paid||0)  : 0;
    $('#editPrin').value = prin ? prin : '';
    $('#editInt').value  = intr ? intr : '';
    $('#editAmount').value = (Math.round((prin+intr)*100)/100).toFixed(2);
    const updateTotal = ()=>{ const p=Number($('#editPrin').value||0), i=Number($('#editInt').value||0); $('#editAmount').value = (Math.round((p+i)*100)/100).toFixed(2); };
    $('#editPrin').oninput = updateTotal; $('#editInt').oninput  = updateTotal;
    $('#editBackdrop').dataset.isDebtRepay = 'true';
  }else{
    $('#editColType').classList.remove('hide');
    $('#editColCat').classList.remove('hide');
    $('#editColAmount').classList.remove('hide');
    $('#editColDebtRepayFields').classList.add('hide');
    $('#editType').disabled = false; $('#editCat').disabled = false;
    $('#editAmount').readOnly = false;
    $('#editType').value = it.type;

    if (!(cats.expense.length || cats.income.length || cats.saving.length)){
      await loadCategoriesAll();
    }
    fillSelect($('#editCat'), (cats[$('#editType').value]||[]), c=>c.category_id, c=>c.name_th||c.category_id);

    $('#editCat').value = it.category_id;
    $('#editAmount').value = String(it.amount||0);
    $('#editBackdrop').dataset.isDebtRepay = 'false';
  }

  $('#editBackdrop').classList.add('show');
  $('#editBackdrop').setAttribute('aria-hidden','false');
}
function closeEdit(){ $('#editBackdrop').classList.remove('show'); $('#editBackdrop').setAttribute('aria-hidden','true'); }
$('#btnCancel').addEventListener('click', closeEdit);
$('#editType').addEventListener('change', ()=>{
  fillSelect($('#editCat'), (cats[$('#editType').value]||[]), c=>c.category_id, c=>c.name_th||c.category_id);
});
$('#btnUpdate').addEventListener('click', async (e)=>{
  const btn = e.currentTarget;
  const tx_id = $('#editTxId').value;
  const isDebtRepay = $('#editBackdrop').dataset.isDebtRepay === 'true';

  await withBusy(btn, async ()=>{
    let r;
    if (isDebtRepay){
      const it = lastItems.find(x=> String(x.tx_id)===String(tx_id));
      const debt_tx_id = it ? it.debt_tx_id : '';
      if (!debt_tx_id){ toast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏ô‡∏µ‡πâ', false); return; }
      const principal_paid = Number($('#editPrin').value||0);
      const interest_paid  = Number($('#editInt').value||0);
      const payload = {
        debt_tx_id,
        date: $('#editDate').value,
        note: $('#editNote').value.trim(),
        principal_paid: Math.round(principal_paid*100)/100,
        interest_paid:  Math.round(interest_paid*100)/100
      };
      r = await api('debts/tx/update', payload, true);
    }else{
      const amount = Number($('#editAmount').value);
      const payload = {
        tx_id,
        date: $('#editDate').value,
        type: $('#editType').value,
        category_id: $('#editCat').value,
        amount: Math.round(amount*100)/100,
        note: $('#editNote').value.trim()
      };
      if (!(payload.date && payload.category_id && isFinite(payload.amount) && payload.amount>0)){
        toast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', false); return;
      }
      r = await api('transactions/update', payload, true);
    }
    if (r.ok){ toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); closeEdit(); refreshList(); }
    else toast(r.message||'‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
  }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶');
});
async function confirmDelete(tx_id, btn){
  if (!tx_id) return;
  if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  const r = await withBusy(btn, ()=> api('transactions/delete', { tx_id }, true), '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‚Ä¶');
  if (r.ok){ toast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); refreshList(); }
  else toast(r.message||'‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false);
}

/** ====== Range shortcuts (‡πÅ‡∏ó‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ====== */
const debouncedRefresh = debounce(()=> refreshList(), 350);
function setRange(from, to){ $('#fFrom').value = from; $('#fTo').value = to; updateRangeUI(); debouncedRefresh(); }
function setRangeDaysBack(days){
  const now=new Date(); const from=toYMD(new Date(now.getFullYear(), now.getMonth(), now.getDate()-days+1)); const to=toYMD(now);
  setRange(from,to);
}
function updateRangeUI(){
  const f=$('#fFrom').value, t=$('#fTo').value;
  const today=todayISO(); const mb=monthBounds(new Date()); const y=new Date().getFullYear();
  const flags={
    today:(f===today && t===today),
    d7:(f===toYMD(new Date(new Date().setDate(new Date().getDate()-6))) && t===today),
    d30:(f===toYMD(new Date(new Date().setDate(new Date().getDate()-29))) && t===today),
    month:(f===mb.start && t===mb.end),
    year:(f===`${y}-01-01` && t===`${y}-12-31`)
  };
  document.querySelectorAll('.chip[data-range]').forEach(ch=>{
    const k=ch.dataset.range;
    const on=(k==='today'&&flags.today)||(k==='7'&&flags.d7)||(k==='30'&&flags.d30)||(k==='month'&&flags.month)||(k==='year'&&flags.year);
    ch.classList.toggle('active',on);
  });
  let txt='‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á'; if(flags.today)txt='‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'; else if(flags.d7)txt='7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î'; else if(flags.d30)txt='30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î'; else if(flags.month)txt='‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ'; else if(flags.year)txt='‡∏õ‡∏µ‡∏ô‡∏µ‡πâ';
  $('#rangeBadge').textContent=txt;
}
document.querySelectorAll('.chip[data-range]').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    const k=ch.dataset.range;
    if (k==='today'){ const d=todayISO(); setRange(d,d); }
    if (k==='7') setRangeDaysBack(7);
    if (k==='30') setRangeDaysBack(30);
    if (k==='month'){ const mb=monthBounds(new Date()); setRange(mb.start, mb.end); }
    if (k==='year'){ const y=new Date().getFullYear(); setRange(`${y}-01-01`, `${y}-12-31`); }
  });
});
$('#fFrom').addEventListener('change', ()=>{ updateRangeUI(); debouncedRefresh(); });
$('#fTo').addEventListener('change',   ()=>{ updateRangeUI(); debouncedRefresh(); });

/** ====== Tabs & Prefetch ====== */
function activateTab(tab){
  const isCreate = (tab==='create');
  $('#tab-create').classList.toggle('active', isCreate);
  $('#tab-list').classList.toggle('active', !isCreate);
  $('#tab-create').setAttribute('aria-selected', String(isCreate));
  $('#tab-list').setAttribute('aria-selected', String(!isCreate));
  $('#pane-create').classList.toggle('active', isCreate);
  $('#pane-list').classList.toggle('active', !isCreate);

  if (isCreate && !loaded.create){
    $('#txDate').value = todayISO();
    setType('expense');
    Promise.all([loadCategoriesAll(), loadDebtsList()]).then(()=> {
      populateCatSelect();
      loadRecentFromAPI();
    }).finally(()=> loaded.create = true);
  }
  if (!isCreate){
    if (!loaded.list){
      const mb = monthBounds(new Date());
      $('#fFrom').value = mb.start; $('#fTo').value = mb.end; updateRangeUI();
      refreshList().then(()=> loaded.list = true);
    } else if (listDirty){
      refreshList().finally(()=> { listDirty = false; });
    }
  }
}
$('#tab-create').addEventListener('click', ()=> activateTab('create'));
$('#tab-list').addEventListener('click',   ()=> activateTab('list'));
$('#btnPrefetchCreate').addEventListener('click', async (e)=>{
  await withBusy(e.currentTarget, async ()=>{
    await Promise.all([loadCategoriesAll(), loadDebtsList()]);
    populateCatSelect();
  }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‚Ä¶');
});
$('#btnRefresh').addEventListener('click', (e)=> refreshList(e.currentTarget));

/** ====== INIT ====== */
(async function init(){
  if (displayName) $('#who').textContent = displayName;
  const overlay = $('#overlay'); overlay.classList.remove('hide');
  let ok=false; try{ ok = await ensureTokenViaLIFF(); }catch{ toast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ú‡πà‡∏≤‡∏ô LIFF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', false); }
  overlay.classList.add('hide');
  if (ok){ $('#app').classList.remove('hide'); activateTab('create'); } else { $('#linkBox').classList.remove('hide'); }
})();

/** ====== UI listeners ====== */
$$('.segbtn').forEach(b=> b.addEventListener('click', ()=> setType(b.dataset.type)));
$('#btnCancel').addEventListener('click', ()=>{ $('#editBackdrop').classList.remove('show'); $('#editBackdrop').setAttribute('aria-hidden','true'); });
</script>
</body>
</html>
